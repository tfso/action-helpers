name: (Release) Package

on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.[0-9]+' # only full releases, eg v1.0.1

jobs:
  setup:
    environment: prod
    runs-on: ubuntu-latest
    name: find version
    outputs:
      version: v${{ steps.semver.outputs.fullversion }}
      prerelease: ${{ steps.semver.outputs.prerelease }}
      major: v${{ steps.semver.outputs.major }}
    steps:
      - name: extract tag version
        id: semver
        uses: booxmedialtd/ws-action-parse-semver@v1
        with:
          input_string: ${{ github.ref }}
          version_extractor_regex: 'refs\/tags\/v(.*)$'

  release:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: update major tag
        uses: actions/github-script@v6
        with:
          script: |
            const sha = '${{ github.sha }}'
            const major = '${{ needs.setup.outputs.major }}';

            try {
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${major}`,
                sha: sha,
                force: true,
              });
              core.info(`Updated ${major} to ${sha}`);

            } catch(err) {
              core.warning(`Failed to update ${major}: ${err}`);
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${major}`,
                sha: sha,
              });

              core.info(`Created ${major} at ${sha}`);
            }

      - uses: tfso/action-changelog-release@v1.1.0
        name: create github release
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
